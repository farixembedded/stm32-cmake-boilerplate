name: Tests

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main, 'feature/initial-project-checkin' ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  GCC_PATH: /tmp/gcc-arm-none-eabi-10-2020-q4-major

jobs:
  test-ubuntu:
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Fetch toolchain for reuse
      run: |
        cd /tmp
        wget https://developer.arm.com/-/media/Files/downloads/gnu-rm/10-2020q4/gcc-arm-none-eabi-10-2020-q4-major-x86_64-linux.tar.bz2 -O toolchain.tar.bz2
        tar xf toolchain.tar.bz2

    - name: Blinky example with fetch
      working-directory: Examples/blinky-example
      run: |
        mkdir build
        cd build
        cmake .. -DSTM32_TOOLHAIN_PATH=$GCC_PATH
        cmake --build .